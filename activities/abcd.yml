version: 1
job:
  type: "ingestion"
source:
  endpoint: "jdbc_1"
  properties:
    pre_sql:
    - |-
      select
        *
      from
        ancd
    post_sql:
    - |-
      SELECT
        TOP 1000 job_info_records.*,
        DATEDIFF(SECOND, start_time, end_time) AS durationFROM (
          SELECT
            DISTINCT(activity_job_instance_id) as job_instance_id
          FROM
            (
              SELECT
                activity.job_instance_id as activity_job_instance_id,
                activity.name as activity_name,
                activity.module as activity_module,
                activity.tag as activity_tag,
                activity.parent_job_instance_id as activity_parent_job_instance_id,
                activity.status as status,
                activity.business_date as business_date,
                activity.start_time as start_time,
                activity.end_time as end_time,
                activity.message as message,
                pipeline.job_instance_id as pipeline_job_instance_id,
                pipeline.name as pipeline_name,
                stage.job_instance_id as stage_job_instance_id,
                stage.tag as stage_name,
                batch.job_instance_id as batch_job_instance_id,
                batch.name as batch_name
              FROM
                (
                  SELECT
                    *
                  FROM
                    job_info
                  WHERE
                    tag = 'pull'
                ) activity
                LEFT JOIN job_info pipeline ON activity.parent_job_instance_id = pipeline.job_instance_id
                LEFT JOIN job_info stage ON pipeline.parent_job_instance_id = stage.job_instance_id
                LEFT JOIN job_info batch ON stage.parent_job_instance_id = batch.job_instance_id
            ) job_detail
          WHERE
            business_date >= CAST('2020-10-01 00:00:00' AS datetime)
            AND business_date <= CAST('2020-10-31 23:59:59' AS datetime)
            AND start_time >= CAST('2020-10-01 00:00:00' AS datetime)
            AND start_time <= CAST('2020-10-31 23:59:59' AS datetime)
            AND end_time >= CAST('2020-10-01 00:00:00' AS datetime)
            AND end_time <= CAST('2020-10-31 23:59:59' AS datetime)
            AND status IN('ABORTED', 'FAILED', 'SUCCESS')
            AND activity_name IN('csv_demo')
            AND(
              activity_job_instance_id IN(201027161626523549)
              OR pipeline_job_instance_id IN(201027161626523549)
              OR stage_job_instance_id IN(201027161626523549)
              OR batch_job_instance_id IN(201027161626523549)
            )
        ) unique_job_instance_ids
        LEFT JOIN job_info job_info_records ON unique_job_instance_ids.job_instance_id = job_info_records.job_instance_idORDER BY job_instance_id desc
    - "select pqr from test"
    query: |-
      select
        *
      from
        users
